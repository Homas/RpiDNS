# RpiDNS RSyslog Configuration - Local Mode (Default)
# Receives syslog messages from remote RpiDNS instances
# This file is overwritten by entrypoint.sh based on RPIDNS_LOGGING mode

#################
#### MODULES ####
#################

# Provides support for local system logging
module(load="imuxsock")

# Note: imklog disabled in container environment (no /proc/kmsg access)
# module(load="imklog" permitnonkernelfacility="on")

# Provides TCP syslog reception on port 10514 (Requirement 11.1, 11.2)
module(load="imtcp")
input(type="imtcp" port="10514")

###########################
#### GLOBAL DIRECTIVES ####
###########################

# Use RFC3339 timestamp format
$ActionFileDefaultTemplate RSYSLOG_FileFormat

# Set default permissions for log files
$FileOwner root
$FileGroup adm
$FileCreateMode 0640
$DirCreateMode 0755
$Umask 0022

# Work directory for rsyslog
$WorkDirectory /var/lib/rsyslog

###############
#### RULES ####
###############

# Template for RpiDNS bind query logs with source IP in filename (Requirement 11.3, 11.4)
# RFC3339 timestamp format: 2024-01-15T10:30:45.123456+00:00
template(name="RpiDNSBindLog" type="string"
    string="/opt/rpidns/logs/bind_%fromhost-ip%_queries.log")

template(name="RFC3339Format" type="string"
    string="%timegenerated:::date-rfc3339% %fromhost-ip% %syslogtag%%msg%\n")

# Route bind/named logs to per-source-IP files
# Matches by program name (named/bind) or syslog facility (local4)
if $programname == 'named' or $programname == 'bind' or $syslogfacility-text == 'local4' then {
    action(type="omfile" dynaFile="RpiDNSBindLog" template="RFC3339Format")
    stop
}

# Default rules for local logging
*.info;mail.none;authpriv.none;cron.none    /var/log/messages
authpriv.*                                   /var/log/secure
mail.*                                       -/var/log/maillog
cron.*                                       /var/log/cron
*.emerg                                      :omusrmsg:*
local7.*                                     /var/log/boot.log
