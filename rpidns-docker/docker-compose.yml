# RpiDNS Container Deployment
# Docker Compose configuration for Bind DNS and Web UI containers
#
# Usage:
#   1. Copy this file to your deployment directory
#   2. Create config directories: ./config/bind and ./config/nginx
#   3. Place your configuration files in the config directories
#   4. Run: docker-compose up -d
#
# Requirements: 4.6, 5.1, 5.2, 5.3, 5.4, 5.5, 13.4

services:
  # Bind DNS Container - ISC Bind9 with RPZ support
  bind:
    image: ghcr.io/homas/rpidns-bind:latest
    container_name: rpidns-bind
    hostname: ${RPIDNS_HOSTNAME:-rpidns.local}
    restart: unless-stopped
    ports:
      - "53:53/tcp"
      - "53:53/udp"
    volumes:
      # User-specific configuration (generated by setup script)
      - ./config/bind:/etc/bind:ro
      # Persistent zone data and cache (bind mount for host access)
      - ./bind-cache:/var/cache/bind
      # Shared logs directory (bind mount for host access)
      - ./logs:/opt/rpidns/logs
    environment:
      - RPIDNS_HOSTNAME=${RPIDNS_HOSTNAME:-rpidns.local}
      - RPIDNS_DNS_TYPE=${RPIDNS_DNS_TYPE:-primary}
      - RPIDNS_DNS_IPNET=${RPIDNS_DNS_IPNET:-192.168.0.0/16}
      - RPIDNS_LOGGING=${RPIDNS_LOGGING:-local}
      - RPIDNS_LOGGING_HOST=${RPIDNS_LOGGING_HOST:-}
    networks:
      - rpidns-net
    healthcheck:
      test: ["CMD", "dig", "@127.0.0.1", "localhost", "+short", "+time=2", "+tries=1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Web UI Container - OpenResty + PHP-FPM + RSyslog
  web:
    image: ghcr.io/homas/rpidns-web:latest
    container_name: rpidns-web
    hostname: ${RPIDNS_HOSTNAME:-rpidns.local}
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "10514:10514"
    volumes:
      # User-specific configuration (generated by setup script)
      - ./config/nginx:/opt/rpidns/conf
      # Web application files (bind mount for host access)
      #- ./www:/opt/rpidns/www
      - ./www/rpisettings.php:/opt/rpidns/www/rpisettings.php
      # SQLite database directory (bind mount for persistence - Requirement 4.6, 13.4)
      - ./www/db:/opt/rpidns/www/db
      # Shared logs directory (bind mount for host access)
      - ./logs:/opt/rpidns/logs
      # Maintenance scripts (bind mount for host access)
      - ./scripts:/opt/rpidns/scripts
      # Bind cache for nsupdate keys (read-only access to TSIG keys)
      - ./bind-cache:/var/cache/bind:ro
    environment:
      - RPIDNS_HOSTNAME=${RPIDNS_HOSTNAME:-rpidns.local}
      - RPIDNS_LOGGING=${RPIDNS_LOGGING:-local}
      - RPIDNS_LOGGING_HOST=${RPIDNS_LOGGING_HOST:-}
      - PHP_FPM_VERSION=${PHP_FPM_VERSION:-83}
    depends_on:
      bind:
        condition: service_healthy
    networks:
      - rpidns-net
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1/blocked.php"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

# Docker network for inter-container communication
networks:
  rpidns-net:
    driver: bridge
    ipam:
      driver: default
